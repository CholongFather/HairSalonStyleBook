<!DOCTYPE html>
<html lang="ko">
<script>
    // FOUC 방지: localStorage에서 즉시 테마 적용
    (function() {
        var t = localStorage.getItem('salon-theme');
        if (t === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    })();
</script>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>늘~오던 헤어살롱</title>
    <base href="/" />
    <!-- GitHub Pages SPA 리다이렉트 핸들러 (404.html과 쌍) -->
    <script type="text/javascript">
        (function(l) {
            if (l.search[1] === '/') {
                var decoded = l.search.slice(1).split('&').map(function(s) {
                    return s.replace(/~and~/g, '&')
                }).join('?');
                window.history.replaceState(null, null,
                    l.pathname.slice(0, -1) + decoded + l.hash
                );
            }
        }(window.location))
    </script>
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700;900&family=Nanum+Pen+Script&family=Gamja+Flower&family=Gaegu&family=Nanum+Myeongjo:wght@400;700&family=Jua&family=Black+Han+Sans&family=Do+Hyeon&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link href="HairSalonStyleBook.styles.css" rel="stylesheet" />
</head>

<body>
    <div id="app">
        <div class="loading-screen" id="loading-screen">
            <div class="loading-scissors">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#1a1a1a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="6" cy="6" r="3"/>
                    <circle cx="6" cy="18" r="3"/>
                    <line x1="20" y1="4" x2="8.12" y2="15.88"/>
                    <line x1="14.47" y1="14.48" x2="20" y2="20"/>
                    <line x1="8.12" y1="8.12" x2="12" y2="12"/>
                </svg>
            </div>
            <div class="loading-logo">늘~오던 헤어살롱</div>
            <div class="loading-subtitle">Style Book</div>
            <div class="loading-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    </div>

    <div id="blazor-error-ui">
        오류가 발생했습니다.
        <a href="." class="reload">새로고침</a>
        <span class="dismiss">&#10005;</span>
    </div>
    <script>
        // 갤러리 데코레이터 드래그용 getBoundingClientRect
        window.gdGetRect = function(el) {
            var r = el.getBoundingClientRect();
            return { left: r.left, top: r.top, width: r.width, height: r.height };
        };
        // 이미지 리사이징 (canvas)
        window.resizeImage = function(base64, maxW, maxH, quality) {
            return new Promise(function(resolve) {
                var img = new Image();
                img.onload = function() {
                    var w = img.width, h = img.height;
                    var scale = Math.min(maxW / w, maxH / h, 1);
                    var nw = Math.round(w * scale), nh = Math.round(h * scale);
                    var c = document.createElement('canvas');
                    c.width = nw; c.height = nh;
                    c.getContext('2d').drawImage(img, 0, 0, nw, nh);
                    var dataUrl = c.toDataURL('image/webp', quality || 0.75);
                    resolve(dataUrl.split(',')[1]); // base64 부분만 반환
                };
                img.src = 'data:image/png;base64,' + base64;
            });
        };
        // 다크 모드
        window.salonTheme = {
            get: function() { return localStorage.getItem('salon-theme') || 'light'; },
            set: function(theme) {
                localStorage.setItem('salon-theme', theme);
                if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
                else document.documentElement.removeAttribute('data-theme');
            }
        };
    </script>
    <script src="_framework/blazor.webassembly.js" autostart="false"></script>
    <script src="lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Service Worker 등록 (이미지 캐싱)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(function() { console.log('Image cache SW registered'); })
                .catch(function(err) { console.log('SW failed:', err); });
        }

        // 최소 2초 로딩 화면 보장
        const minLoadTime = new Promise(resolve => setTimeout(resolve, 2000));
        const blazorStart = Blazor.start();
        Promise.all([minLoadTime, blazorStart]).then(() => {
            const loading = document.getElementById('loading-screen');
            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => loading.style.display = 'none', 400);
            }
        }).catch(err => {
            console.error('Blazor start failed:', err);
            const loading = document.getElementById('loading-screen');
            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => loading.style.display = 'none', 400);
            }
        });
    </script>
</body>

</html>
