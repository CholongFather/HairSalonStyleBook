@page "/pay"
@inject IShopConfigService ShopConfigService
@inject IJSRuntime JS

<PageTitle>계좌정보 - 늘-오던 헤어살롱</PageTitle>

<div class="pay-page">
    @if (_expired)
    {
        <!-- 만료 화면 -->
        <div class="pay-card pay-expired-card">
            <div class="pay-expired-icon">
                <i class="bi bi-clock-history"></i>
            </div>
            <h2 class="pay-expired-title">페이지가 만료되었습니다</h2>
            <p class="pay-expired-msg">보안을 위해 2분간 동작이 없어<br/>계좌 정보가 숨겨졌습니다.</p>
            <p class="pay-expired-hint">QR코드를 다시 스캔해주세요</p>
        </div>
    }
    else
    {
        <div class="pay-card">
            <div class="pay-logo">
                <i class="bi bi-scissors"></i>
            </div>
            <h1 class="pay-title">늘-오던 헤어살롱</h1>
            <p class="pay-subtitle">계좌 정보</p>

            <div class="pay-divider"></div>

            <div class="pay-info">
                <div class="pay-row">
                    <span class="pay-label">은행</span>
                    <span class="pay-value">@_config.BankName</span>
                </div>
                <div class="pay-row pay-row-main">
                    <span class="pay-label">계좌번호</span>
                    <span class="pay-value pay-account">@_config.AccountNumber</span>
                </div>
                <div class="pay-row">
                    <span class="pay-label">예금주</span>
                    <span class="pay-value">@_config.AccountHolder</span>
                </div>
            </div>

            <!-- 계좌번호 복사 -->
            <button class="pay-copy-btn" @onclick="CopyAccount">
                <i class="bi @(_copied ? "bi-check-circle-fill" : "bi-clipboard")"></i>
                @(_copied ? "복사 완료!" : "계좌번호 복사하기")
            </button>

            <!-- 뱅킹 앱으로 열기 -->
            <div class="pay-apps">
                <p class="pay-apps-label">뱅킹 앱에서 바로 송금</p>
                <div class="pay-app-btns">
                    <button class="pay-app-btn toss" @onclick="OpenToss">
                        <span class="pay-app-name">토스</span>
                    </button>
                    <button class="pay-app-btn kakao" @onclick="OpenKakaoBank">
                        <span class="pay-app-name">카카오뱅크</span>
                    </button>
                    <button class="pay-app-btn woori" @onclick="OpenWooriBank">
                        <span class="pay-app-name">우리WON</span>
                    </button>
                </div>
                <p class="pay-apps-note">앱이 설치되어 있어야 열립니다</p>
            </div>

            <p class="pay-note">복사 후 뱅킹 앱에 붙여넣기 하세요</p>

            <!-- 남은 시간 + 닫기 -->
            <div class="pay-footer">
                <div class="pay-timer">
                    <i class="bi bi-shield-lock"></i>
                    <span>@(_remainingSeconds)초 후 자동 만료</span>
                </div>
                <button class="pay-close-btn" @onclick="ClosePage">
                    <i class="bi bi-x-lg"></i> 닫기
                </button>
            </div>
        </div>
    }
</div>

@implements IDisposable

@code {
    private ShopConfig _config = new();
    private bool _copied;
    private bool _isIOS;
    private bool _expired;
    private int _remainingSeconds = 120; // 2분
    private System.Threading.Timer? _countdownTimer;
    private DotNetObjectReference<Pay>? _dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        _config = await ShopConfigService.GetAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // iOS/Android 자동 감지
            _isIOS = await JS.InvokeAsync<bool>("eval", "(/iPhone|iPad|iPod/i).test(navigator.userAgent)");

            // 비활동 타이머 시작
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("eval", @"
                window._payTimer = {
                    lastActivity: Date.now(),
                    reset: function() { this.lastActivity = Date.now(); }
                };
                ['touchstart','click','scroll','keydown','keyup'].forEach(function(evt) {
                    document.addEventListener(evt, function() { window._payTimer.reset(); }, {passive:true});
                });
            ");
            StartCountdown();
            StateHasChanged();
        }
    }

    private void StartCountdown()
    {
        _countdownTimer = new System.Threading.Timer(async _ =>
        {
            if (_expired) return;

            try
            {
                // JS에서 마지막 활동 시간 확인
                var elapsed = await JS.InvokeAsync<double>("eval",
                    "Date.now() - window._payTimer.lastActivity");

                var secondsSinceActivity = (int)(elapsed / 1000);
                var newRemaining = 120 - secondsSinceActivity;

                if (newRemaining <= 0)
                {
                    _expired = true;
                    _remainingSeconds = 0;
                    _countdownTimer?.Dispose();
                }
                else
                {
                    _remainingSeconds = newRemaining;
                }

                await InvokeAsync(StateHasChanged);
            }
            catch
            {
                // 페이지 벗어남 등 예외 무시
            }
        }, null, 1000, 1000);
    }

    private async Task CopyAccount()
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", _config.AccountNumber);
        _copied = true;
        StateHasChanged();
        await Task.Delay(2000);
        _copied = false;
        StateHasChanged();
    }

    private async Task OpenToss()
    {
        // 토스 딥링크: bank 파라미터는 한글 은행명 (숫자 코드 아님)
        var bankName = GetTossBankName(_config.BankName);
        var accountNo = new string(_config.AccountNumber.Where(char.IsDigit).ToArray());
        var scheme = $"supertoss://send?bank={bankName}&accountNo={accountNo}";
        await TryOpenApp(scheme, "https://toss.im");
    }

    private async Task OpenKakaoBank()
    {
        if (_isIOS)
            await JS.InvokeVoidAsync("window.open", "kakaobank://", "_self");
        else
            await TryOpenApp("kakaobank://", "intent://transfer#Intent;scheme=kakaobank;package=com.kakaobank.channel;end");
    }

    private async Task OpenWooriBank()
    {
        if (_isIOS)
            await JS.InvokeVoidAsync("window.open", "wooribank://", "_self");
        else
            await TryOpenApp("wooribank://", "intent://#Intent;scheme=wooribank;package=com.wooribank.pib.smart;end");
    }

    private async Task TryOpenApp(string scheme, string fallback)
    {
        await JS.InvokeVoidAsync("eval", $@"
            var w = window.open('{scheme}', '_self');
            setTimeout(function() {{ if(document.hasFocus()) window.location.href = '{fallback}'; }}, 1500);
        ");
    }

    // 토스 딥링크용 한글 은행명 (숫자 코드가 아닌 한글명 사용)
    private static string GetTossBankName(string bankName) => bankName switch
    {
        "우리은행" => "우리",
        "국민은행" => "국민",
        "신한은행" => "신한",
        "하나은행" => "하나",
        "카카오뱅크" => "카카오",
        "토스뱅크" => "토스",
        "농협" => "농협",
        "기업은행" => "기업",
        "SC제일은행" => "SC제일",
        _ => bankName.Replace("은행", "")
    };

    private async Task ClosePage()
    {
        _expired = true;
        _remainingSeconds = 0;
        _countdownTimer?.Dispose();
        // 탭 닫기 시도, 실패하면 뒤로가기 방지용 히스토리 조작
        await JS.InvokeVoidAsync("eval", @"
            window.close();
            setTimeout(function() {
                history.replaceState(null, '', location.href);
                history.pushState(null, '', location.href);
                window.addEventListener('popstate', function() {
                    history.pushState(null, '', location.href);
                });
            }, 100);
        ");
    }

    public void Dispose()
    {
        _countdownTimer?.Dispose();
        _dotNetRef?.Dispose();
    }
}

<style>
    .pay-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background: linear-gradient(135deg, #f5f0eb 0%, #e8e3d8 100%);
    }

    .pay-card {
        width: 100%;
        max-width: 360px;
        background: #fff;
        border-radius: 20px;
        padding: 2rem 1.5rem;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    }

    .pay-logo {
        width: 56px;
        height: 56px;
        margin: 0 auto 0.8rem;
        background: linear-gradient(135deg, var(--salon-green) 0%, #9bc5a3 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.5rem;
    }

    .pay-title {
        font-family: var(--font-serif);
        font-size: 1.2rem;
        font-weight: 900;
        color: var(--salon-black);
        margin: 0;
    }

    .pay-subtitle {
        font-family: var(--font-serif);
        font-size: 0.8rem;
        color: var(--salon-gray);
        margin: 0.2rem 0 0;
    }

    .pay-divider {
        width: 40px;
        height: 2px;
        background: var(--salon-green);
        margin: 1rem auto;
        border-radius: 1px;
    }

    .pay-info {
        margin-bottom: 1.5rem;
    }

    .pay-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0;
        border-bottom: 1px solid rgba(232, 227, 220, 0.4);
    }

    .pay-row:last-child {
        border-bottom: none;
    }

    .pay-row-main {
        padding: 0.8rem 0;
    }

    .pay-label {
        font-family: var(--font-serif);
        font-size: 0.8rem;
        color: var(--salon-gray);
        font-weight: 600;
    }

    .pay-value {
        font-family: var(--font-serif);
        font-size: 0.9rem;
        color: var(--salon-dark);
        font-weight: 700;
    }

    .pay-account {
        font-size: 1.1rem;
        letter-spacing: 0.05em;
    }

    .pay-copy-btn {
        width: 100%;
        padding: 0.85rem;
        border: none;
        border-radius: 12px;
        background: var(--salon-green);
        color: #fff;
        font-family: var(--font-serif);
        font-size: 0.95rem;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .pay-copy-btn:active {
        transform: scale(0.97);
        opacity: 0.9;
    }

    /* 뱅킹 앱 버튼 */
    .pay-apps {
        margin-top: 1.2rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(232, 227, 220, 0.4);
    }

    .pay-apps-label {
        font-family: var(--font-serif);
        font-size: 0.75rem;
        color: var(--salon-gray);
        margin: 0 0 0.6rem;
    }

    .pay-app-btns {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .pay-app-btn {
        flex: 1;
        padding: 0.6rem 0.4rem;
        border: 1px solid;
        border-radius: 10px;
        font-family: var(--font-serif);
        cursor: pointer;
        transition: all 0.2s;
        background: #fff;
    }

    .pay-app-btn:active {
        transform: scale(0.96);
    }

    .pay-app-name {
        font-size: 0.75rem;
        font-weight: 700;
    }

    .pay-app-btn.toss {
        border-color: #0064ff;
        color: #0064ff;
    }

    .pay-app-btn.kakao {
        border-color: #fee500;
        color: #3c1e1e;
        background: #fff9db;
    }

    .pay-app-btn.woori {
        border-color: #005baa;
        color: #005baa;
    }

    .pay-apps-note {
        font-family: var(--font-serif);
        font-size: 0.65rem;
        color: var(--salon-light-gray);
        margin: 0.5rem 0 0;
    }

    .pay-note {
        font-family: var(--font-serif);
        font-size: 0.72rem;
        color: var(--salon-gray);
        margin: 0.8rem 0 0;
    }

    /* 하단 영역 */
    .pay-footer {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.6rem;
    }

    .pay-timer {
        font-family: var(--font-serif);
        font-size: 0.65rem;
        color: var(--salon-light-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }

    .pay-close-btn {
        background: none;
        border: 1px solid var(--salon-light-gray);
        border-radius: 20px;
        padding: 0.35rem 1rem;
        font-family: var(--font-serif);
        font-size: 0.72rem;
        color: var(--salon-gray);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .pay-close-btn:active {
        background: rgba(0,0,0,0.04);
        transform: scale(0.96);
    }

    /* 만료 화면 */
    .pay-expired-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
    }

    .pay-expired-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: rgba(232, 227, 220, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: var(--salon-gray);
        margin-bottom: 1rem;
    }

    .pay-expired-title {
        font-family: var(--font-serif);
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--salon-black);
        margin: 0 0 0.5rem;
    }

    .pay-expired-msg {
        font-family: var(--font-serif);
        font-size: 0.8rem;
        color: var(--salon-gray);
        margin: 0 0 1rem;
        line-height: 1.6;
    }

    .pay-expired-hint {
        font-family: var(--font-serif);
        font-size: 0.75rem;
        color: var(--salon-green);
        font-weight: 700;
        margin: 0;
        padding: 0.5rem 1.2rem;
        background: rgba(123, 163, 131, 0.1);
        border-radius: 20px;
    }
</style>
