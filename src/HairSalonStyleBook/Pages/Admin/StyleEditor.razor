@page "/admin/edit"
@page "/admin/edit/{Id}"
@attribute [Authorize(Roles = "Admin")]
@inject IStyleService StyleService
@inject IAuditService AuditService
@inject IImageService ImageService
@inject NavigationManager Nav

<PageTitle>@(_isEdit ? "스타일 수정" : "새 스타일") - 관리자</PageTitle>

<div class="container editor-page">
    <button class="btn btn-back" @onclick="GoBack">
        <i class="bi bi-arrow-left"></i> 목록으로
    </button>

    <h2 class="editor-title">@(_isEdit ? "스타일 수정" : "새 스타일 등록")</h2>

    <EditForm Model="_style" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        <!-- 제목 -->
        <div class="mb-3">
            <label class="form-label">제목</label>
            <InputText @bind-Value="_style.Title" class="form-control editor-input" placeholder="스타일 제목" />
        </div>

        <!-- 카테고리 & 시술 -->
        <div class="row mb-3">
            <div class="col-7">
                <label class="form-label">카테고리</label>
                <InputSelect @bind-Value="_style.Category" class="form-select editor-input">
                    <option value="@StyleCategory.남성">남성</option>
                    <option value="@StyleCategory.여성숏">여성 숏</option>
                    <option value="@StyleCategory.여성단발">여성 단발</option>
                    <option value="@StyleCategory.여성미디움">여성 미디움</option>
                    <option value="@StyleCategory.여성롱">여성 롱</option>
                </InputSelect>
            </div>
            <div class="col-5">
                <label class="form-label">시술</label>
                <InputSelect @bind-Value="_style.Service" class="form-select editor-input">
                    <option value="@ServiceType.커트">커트</option>
                    <option value="@ServiceType.펌">펌</option>
                    <option value="@ServiceType.염색">염색</option>
                </InputSelect>
            </div>
        </div>

        <!-- 상세 설명 -->
        <div class="mb-3">
            <label class="form-label">상세 설명</label>
            <RichTextEditor @bind-Value="_style.Description" />
        </div>

        <!-- 이미지 업로드 -->
        <div class="mb-3">
            <label class="form-label">이미지</label>

            <!-- 앵글 선택 -->
            <div class="angle-selector mb-2">
                <span class="angle-label">앵글:</span>
                @foreach (var angle in _angleOptions)
                {
                    var a = angle;
                    <button type="button"
                            class="angle-chip @(IsAngleActive(a.Key))"
                            @onclick="() => ToggleAngle(a.Key)">
                        @a.Value
                    </button>
                }
            </div>

            <!-- 업로드 영역 (드래그앤드랍 + 클릭) -->
            <div class="upload-area @(_dragOver ? "drag-over" : "")"
                 @ondragover="OnDragOver" @ondragover:preventDefault
                 @ondragleave="() => _dragOver = false"
                 @ondrop="OnDrop" @ondrop:preventDefault>
                <InputFile OnChange="OnFilesSelected" multiple accept="image/*" class="upload-input" id="imageUpload" />
                <label for="imageUpload" class="upload-label">
                    <i class="bi @(_dragOver ? "bi-cloud-arrow-down-fill" : "bi-cloud-arrow-up")"></i>
                    <span>이미지를 드래그하거나 클릭하여 선택</span>
                    <small>JPG, PNG, WebP / 최대 5MB</small>
                </label>
            </div>

            <!-- 업로드 진행 -->
            @if (_uploading)
            {
                <div class="upload-progress mt-2">
                    <div class="spinner-border spinner-border-sm me-1"></div>
                    <span>업로드 중... (@_uploadedCount/@_totalUploadCount)</span>
                </div>
            }
            @if (_skippedCount > 0 && !_uploading)
            {
                <div class="alert alert-warning py-1 px-2 mt-1" style="font-size:0.75rem;">
                    <i class="bi bi-exclamation-triangle"></i> @(_skippedCount)개 파일이 5MB 초과로 건너뛰었습니다.
                </div>
            }

            @if (_imageSaved)
            {
                <div class="upload-progress mt-2" style="color: var(--salon-green);">
                    <i class="bi bi-check-circle-fill me-1"></i> 저장됨
                </div>
            }

            <!-- 업로드된 이미지 미리보기 (드래그 순서 변경) -->
            @if (_style.ImageUrls.Any())
            {
                <div class="uploaded-images mt-2">
                    @for (var i = 0; i < _style.ImageUrls.Count; i++)
                    {
                        var idx = i;
                        var url = _style.ImageUrls[idx];
                        <div class="uploaded-item @(_dragIdx == idx ? "dragging" : "") @(_dropTargetIdx == idx ? "drop-target" : "")"
                             draggable="true"
                             @ondragstart="() => OnImageDragStart(idx)"
                             @ondragover="() => OnImageDragOver(idx)" @ondragover:preventDefault
                             @ondragend="OnImageDragEnd" @ondrop:preventDefault>
                            <img src="@url" alt="업로드 이미지" loading="lazy" />
                            <div class="uploaded-order">@(idx + 1)</div>
                            @{ var angleTag = GetAngleFromUrl(url); }
                            @if (!string.IsNullOrEmpty(angleTag))
                            {
                                <div class="uploaded-angle">@angleTag</div>
                            }
                            <button type="button" class="uploaded-remove" @onclick="() => RemoveImage(url)">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- 추천 모질 -->
        <div class="mb-3">
            <label class="form-label">추천 모질</label>
            <div class="d-flex flex-wrap gap-2">
                @foreach (var ht in _hairTypeOptions)
                {
                    var h = ht;
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               id="ht_@h" checked="@(_style.RecommendedHairTypes.Contains(h))"
                               @onchange="e => ToggleListItem(_style.RecommendedHairTypes, h, (bool)(e.Value ?? false))" />
                        <label class="form-check-label" for="ht_@h">@h</label>
                    </div>
                }
            </div>
        </div>

        <!-- 추천 대상 -->
        <div class="mb-3">
            <label class="form-label">이런 분께 추천</label>
            <div class="d-flex flex-wrap gap-2">
                @foreach (var rf in _recommendedForOptions)
                {
                    var r = rf;
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               id="rf_@r" checked="@(_style.RecommendedFor.Contains(r))"
                               @onchange="e => ToggleListItem(_style.RecommendedFor, r, (bool)(e.Value ?? false))" />
                        <label class="form-check-label" for="rf_@r">@r</label>
                    </div>
                }
            </div>
        </div>

        <!-- 스타일링 팁 -->
        <div class="mb-3">
            <label class="form-label">스타일링 팁</label>
            <InputText @bind-Value="_style.StylingTip" class="form-control editor-input" placeholder="간단한 스타일링 팁 한줄" />
        </div>

        <!-- 해시태그 -->
        <div class="mb-3">
            <label class="form-label">해시태그</label>
            <small class="text-muted d-block mb-1">쉼표로 구분하여 입력</small>
            <input type="text"
                   class="form-control editor-input"
                   placeholder="예: 레이어드컷, 볼륨펌, 자연스러운"
                   value="@string.Join(", ", _style.Hashtags)"
                   @onchange="OnHashtagsChanged" />
            @if (_style.Hashtags.Any())
            {
                <div class="mt-1">
                    <HashtagList Hashtags="_style.Hashtags" Clickable="false" />
                </div>
            }
        </div>

        <!-- 연관 게시글 -->
        <div class="mb-3">
            <label class="form-label">연관 게시글</label>
            <small class="text-muted d-block mb-1">검색하여 연관 스타일을 추가하세요</small>
            <div class="related-select-wrapper">
                <input type="text"
                       class="form-control editor-input"
                       placeholder="스타일 제목으로 검색..."
                       @bind="_relatedSearchText"
                       @bind:event="oninput"
                       @onfocus="() => _showRelatedDropdown = true" />
                @if (_showRelatedDropdown && _filteredAvailablePosts.Any())
                {
                    <div class="related-dropdown">
                        @foreach (var post in _filteredAvailablePosts)
                        {
                            <div class="related-dropdown-item" @onclick="() => AddRelatedPost(post)">
                                <span class="related-category-badge">@post.Category</span>
                                @post.Title
                            </div>
                        }
                    </div>
                }
            </div>
            @if (_style.RelatedPostIds.Any())
            {
                <div class="related-selected-list mt-2">
                    @foreach (var id in _style.RelatedPostIds)
                    {
                        var relatedPost = _allPosts.FirstOrDefault(p => p.Id == id);
                        <span class="related-chip">
                            @if (relatedPost != null)
                            {
                                <span class="related-category-badge-sm">@relatedPost.Category</span>
                                @relatedPost.Title
                            }
                            else
                            {
                                @id
                            }
                            <button type="button" class="related-chip-remove" @onclick="() => RemoveRelatedPost(id)">
                                <i class="bi bi-x"></i>
                            </button>
                        </span>
                    }
                </div>
            }
        </div>

        <!-- 게시 여부 & 배지 -->
        <div class="mb-4">
            <div class="form-check mb-2">
                <InputCheckbox @bind-Value="_style.IsPublished" class="form-check-input" id="publishCheck" />
                <label class="form-check-label" for="publishCheck">게시하기</label>
            </div>
            <div class="form-check mb-2">
                <InputCheckbox @bind-Value="_style.IsSignature" class="form-check-input" id="signatureCheck" />
                <label class="form-check-label" for="signatureCheck" style="color: var(--salon-accent); font-weight: 600;">
                    <i class="bi bi-award-fill"></i> 시그니처 스타일
                </label>
            </div>
            <div class="form-check">
                <InputCheckbox @bind-Value="_style.IsFeatured" class="form-check-input" id="featuredCheck" />
                <label class="form-check-label" for="featuredCheck" style="color: #e53935; font-weight: 600;">
                    <i class="bi bi-fire"></i> 인기 스타일
                </label>
            </div>
        </div>

        <!-- 버튼 -->
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-salon" disabled="@(_saving || _uploading)">
                @if (_saving)
                {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                }
                @(_isEdit ? "수정" : "등록")
            </button>
            <button type="button" class="btn btn-salon-outline" @onclick="GoBack">취소</button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public string? Id { get; set; }

    private StylePost _style = new();
    private bool _isEdit;
    private bool _saving;
    private bool _uploading;
    private int _uploadedCount;
    private int _totalUploadCount;
    private bool _imageSaved;
    private bool _dragOver;
    private int _dragIdx = -1;
    private int _dropTargetIdx = -1;
    private string _selectedAngle = "";
    private List<StylePost> _allPosts = new();
    private string _relatedSearchText = "";
    private bool _showRelatedDropdown;

    private static readonly Dictionary<string, string> _angleOptions = new()
    {
        { "front", "정면" },
        { "side", "측면" },
        { "back", "후면" },
        { "detail", "디테일" }
    };

    private static readonly string[] _hairTypeOptions = { "직모", "반곱슬", "곱슬", "가는모", "부드러운모", "굵은모", "뻣뻣한모", "숱많은", "숱적은" };
    private static readonly string[] _recommendedForOptions = {
        "매일 고데기가 귀찮은 분", "자연스러운 웨이브를 원하는 분", "볼륨이 부족해 고민인 분",
        "숱이 적어 고민인 분", "깔끔한 인상을 원하는 분", "분위기 변화를 원하는 분",
        "스타일 변화를 원하는 분", "곱슬기를 살리고 싶은 분", "숱 정리가 필요한 분",
        "세련된 이미지를 원하는 분", "가볍고 시원한 스타일을 원하는 분", "풍성해 보이고 싶은 분"
    };

    private void ToggleListItem(List<string> list, string item, bool isChecked)
    {
        if (isChecked && !list.Contains(item))
            list.Add(item);
        else if (!isChecked)
            list.Remove(item);
    }

    private IEnumerable<StylePost> _filteredAvailablePosts =>
        _allPosts.Where(p =>
            p.Id != _style.Id &&
            !_style.RelatedPostIds.Contains(p.Id) &&
            (string.IsNullOrWhiteSpace(_relatedSearchText) ||
             p.Title.Contains(_relatedSearchText, StringComparison.OrdinalIgnoreCase) ||
             p.Category.ToString().Contains(_relatedSearchText, StringComparison.OrdinalIgnoreCase)))
        .Take(10);

    protected override async Task OnParametersSetAsync()
    {
        _allPosts = await StyleService.GetAllAsync();

        if (!string.IsNullOrEmpty(Id))
        {
            _isEdit = true;
            var existing = await StyleService.GetByIdAsync(Id);
            if (existing != null)
                _style = existing;
        }
    }

    private int _skippedCount;

    private async Task OnFilesSelected(InputFileChangeEventArgs e)
    {
        var maxSize = 5 * 1024 * 1024; // 5MB
        var files = e.GetMultipleFiles(10);
        _uploading = true;
        _uploadedCount = 0;
        _skippedCount = 0;
        _totalUploadCount = files.Count;
        StateHasChanged();

        foreach (var file in files)
        {
            try
            {
                if (file.Size > maxSize) { _skippedCount++; continue; }

                using var stream = file.OpenReadStream(maxSize);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var data = ms.ToArray();

                // 앵글 선택 시 파일명에 태그 추가
                var uploadName = file.Name;
                if (!string.IsNullOrEmpty(_selectedAngle))
                {
                    var ext = Path.GetExtension(file.Name);
                    var nameOnly = Path.GetFileNameWithoutExtension(file.Name);
                    uploadName = $"{nameOnly}_{_selectedAngle}{ext}";
                }
                var url = await ImageService.UploadAsync(uploadName, data, file.ContentType);
                _style.ImageUrls.Add(url);
                _uploadedCount++;
                StateHasChanged();
            }
            catch
            {
                // 개별 파일 업로드 실패 무시
            }
        }

        _uploading = false;
        await AutoSaveImages();
    }

    private async Task RemoveImage(string url)
    {
        _style.ImageUrls.Remove(url);
        await AutoSaveImages();
    }

    private async Task AutoSaveImages()
    {
        if (_isEdit)
        {
            await StyleService.UpdateAsync(_style);
            _imageSaved = true;
            StateHasChanged();
            await Task.Delay(1500);
            _imageSaved = false;
            StateHasChanged();
        }
    }

    private string IsAngleActive(string key) => _selectedAngle == key ? "active" : "";
    private void ToggleAngle(string key) => _selectedAngle = _selectedAngle == key ? "" : key;

    // URL에서 앵글 태그 추출
    private static string GetAngleFromUrl(string url)
    {
        var decoded = Uri.UnescapeDataString(url);
        foreach (var kv in _angleOptions)
        {
            if (decoded.Contains($"_{kv.Key}.") || decoded.Contains($"_{kv.Key}?"))
                return kv.Value;
        }
        return "";
    }

    // 드래그앤드랍 - 파일 업로드
    private void OnDragOver(DragEventArgs e) => _dragOver = true;

    private async Task OnDrop(DragEventArgs e)
    {
        _dragOver = false;
        // InputFile이 처리 (브라우저 기본 동작)
    }

    // 드래그앤드랍 - 이미지 순서 변경
    private void OnImageDragStart(int idx) => _dragIdx = idx;

    private void OnImageDragOver(int idx) => _dropTargetIdx = idx;

    private async Task OnImageDragEnd()
    {
        if (_dragIdx >= 0 && _dropTargetIdx >= 0 && _dragIdx != _dropTargetIdx)
        {
            var item = _style.ImageUrls[_dragIdx];
            _style.ImageUrls.RemoveAt(_dragIdx);
            _style.ImageUrls.Insert(_dropTargetIdx, item);
            await AutoSaveImages();
        }
        _dragIdx = -1;
        _dropTargetIdx = -1;
    }

    private void AddRelatedPost(StylePost post)
    {
        if (!_style.RelatedPostIds.Contains(post.Id))
            _style.RelatedPostIds.Add(post.Id);
        _relatedSearchText = "";
        _showRelatedDropdown = false;
    }

    private void RemoveRelatedPost(string postId)
    {
        _style.RelatedPostIds.Remove(postId);
    }

    private async Task HandleSubmit()
    {
        _saving = true;

        if (_isEdit)
        {
            await StyleService.UpdateAsync(_style);
            await AuditService.LogAsync("Update", _style.Id, _style.Title, $"스타일 '{_style.Title}' 수정");
        }
        else
        {
            var created = await StyleService.CreateAsync(_style);
            await AuditService.LogAsync("Create", created.Id, created.Title, $"스타일 '{created.Title}' 생성");
        }

        _saving = false;
        Nav.NavigateTo("admin");
    }

    private void OnHashtagsChanged(ChangeEventArgs e)
    {
        _style.Hashtags = ParseCommaSeparated(e.Value?.ToString());
    }

    private static List<string> ParseCommaSeparated(string? input)
    {
        if (string.IsNullOrWhiteSpace(input)) return new();
        return input.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                    .Where(s => !string.IsNullOrWhiteSpace(s))
                    .ToList();
    }


    private void GoBack() => Nav.NavigateTo("admin");
}

<style>
    .editor-page {
        max-width: 600px;
        padding-top: 0.5rem;
        padding-bottom: 2rem;
    }

    .editor-title {
        font-family: var(--font-serif);
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-family: var(--font-serif);
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--salon-black);
    }

    .editor-input {
        border-radius: 4px;
        border: 1px solid var(--salon-light-gray);
        font-family: var(--font-serif);
        font-size: 0.85rem;
    }

    .editor-input:focus {
        border-color: var(--salon-green);
        box-shadow: 0 0 0 2px rgba(123, 163, 131, 0.15);
    }

    .btn-back {
        font-family: var(--font-serif);
        font-size: 0.85rem;
        color: var(--salon-gray);
        background: none;
        border: none;
        padding: 0.5rem 0;
        margin-bottom: 0.5rem;
    }

    /* 이미지 업로드 */
    .upload-area {
        position: relative;
    }

    .upload-input {
        position: absolute;
        width: 0;
        height: 0;
        opacity: 0;
    }

    .upload-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        border: 2px dashed var(--salon-light-gray);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--salon-gray);
        font-family: var(--font-serif);
    }

    /* 앵글 선택 */
    .angle-selector {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        flex-wrap: wrap;
    }

    .angle-label {
        font-family: var(--font-serif);
        font-size: 0.75rem;
        color: var(--salon-gray);
        margin-right: 0.2rem;
    }

    .angle-chip {
        padding: 0.2rem 0.7rem;
        border: 1px solid var(--salon-light-gray);
        border-radius: 16px;
        background: var(--salon-white);
        font-family: var(--font-serif);
        font-size: 0.72rem;
        color: var(--salon-gray);
        cursor: pointer;
        transition: all 0.2s;
    }

    .angle-chip:hover {
        border-color: var(--salon-green);
        color: var(--salon-dark);
    }

    .angle-chip.active {
        background: var(--salon-green);
        color: #fff;
        border-color: var(--salon-green);
    }

    /* 이미지 앵글 태그 */
    .uploaded-angle {
        position: absolute;
        bottom: 4px;
        left: 4px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        font-family: var(--font-serif);
        font-size: 0.6rem;
        padding: 1px 6px;
        border-radius: 4px;
        pointer-events: none;
    }

    .upload-area.drag-over .upload-label {
        border-color: var(--salon-green);
        color: var(--salon-green);
        background: rgba(123, 163, 131, 0.1);
        border-style: solid;
    }

    .upload-label:hover {
        border-color: var(--salon-green);
        color: var(--salon-green);
        background: rgba(123, 163, 131, 0.05);
    }

    .upload-label i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .upload-label span {
        font-size: 0.85rem;
    }

    .upload-label small {
        font-size: 0.7rem;
        margin-top: 0.2rem;
    }

    .upload-progress {
        font-size: 0.85rem;
        color: var(--salon-green);
        display: flex;
        align-items: center;
    }

    /* 업로드된 이미지 목록 */
    .uploaded-images {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }

    .uploaded-item {
        position: relative;
        aspect-ratio: 3/4;
        overflow: hidden;
        border-radius: 4px;
        border: 1px solid var(--salon-light-gray);
    }

    .uploaded-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .uploaded-order {
        position: absolute;
        top: 4px;
        left: 4px;
        background: var(--salon-green);
        color: #fff;
        font-size: 0.65rem;
        width: 1.2rem;
        height: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .uploaded-item[draggable="true"] {
        cursor: grab;
    }

    .uploaded-item.dragging {
        opacity: 0.4;
    }

    .uploaded-item.drop-target {
        border-color: var(--salon-green);
        border-width: 2px;
        box-shadow: 0 0 0 2px rgba(123, 163, 131, 0.3);
    }

    .uploaded-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        background: none;
        border: none;
        color: #dc3545;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 0;
        text-shadow: 0 0 3px rgba(255,255,255,0.8);
    }

    /* 연관 게시글 드롭다운 */
    .related-select-wrapper {
        position: relative;
    }

    .related-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--salon-white, #fff);
        border: 1px solid var(--salon-light-gray);
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .related-dropdown-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        font-size: 0.85rem;
        font-family: var(--font-serif);
        border-bottom: 1px solid #f0f0f0;
    }

    .related-dropdown-item:hover {
        background-color: rgba(123, 163, 131, 0.1);
    }

    .related-category-badge {
        display: inline-block;
        font-size: 0.7rem;
        padding: 0.1rem 0.4rem;
        background: var(--salon-green);
        color: #fff;
        border-radius: 8px;
        margin-right: 0.4rem;
    }

    .related-selected-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .related-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.25rem 0.5rem;
        background: var(--salon-green);
        color: #fff;
        font-size: 0.8rem;
        font-family: var(--font-serif);
        border-radius: 4px;
    }

    .related-category-badge-sm {
        font-size: 0.65rem;
        padding: 0.05rem 0.3rem;
        background: rgba(255,255,255,0.3);
        border-radius: 4px;
    }

    .related-chip-remove {
        background: none;
        border: none;
        color: #fff;
        padding: 0;
        font-size: 0.9rem;
        cursor: pointer;
        line-height: 1;
        opacity: 0.7;
    }

    .related-chip-remove:hover {
        opacity: 1;
    }
</style>
