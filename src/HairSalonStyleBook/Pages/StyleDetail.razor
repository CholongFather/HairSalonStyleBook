@page "/style/{Id}"
@attribute [Authorize]
@inject IStyleService StyleService
@inject NavigationManager Nav

<PageTitle>@(_style?.Title ?? "스타일 상세") - 늘-오던 헤어살롱</PageTitle>

<div class="container salon-detail-page">
    <!-- 뒤로가기 + 이전/다음 -->
    <div class="detail-nav-bar">
        <button class="btn btn-back" @onclick="GoBack">
            <i class="bi bi-chevron-left"></i> 목록
        </button>
        <div class="detail-nav-arrows">
            @if (_prevId != null)
            {
                <button class="btn btn-nav-arrow" @onclick="GoPrev" title="이전 스타일">
                    <i class="bi bi-chevron-left"></i>
                </button>
            }
            @if (_styleIndex >= 0 && _totalCount > 0)
            {
                <span class="detail-nav-counter">@(_styleIndex + 1) / @_totalCount</span>
            }
            @if (_nextId != null)
            {
                <button class="btn btn-nav-arrow" @onclick="GoNext" title="다음 스타일">
                    <i class="bi bi-chevron-right"></i>
                </button>
            }
        </div>
    </div>

    @if (_loading)
    {
        <div class="skeleton-detail">
            <div class="skeleton skeleton-title mx-auto"></div>
            <div class="skeleton skeleton-text-sm mx-auto mb-3" style="width:30%"></div>
            <div class="skeleton skeleton-text mt-3"></div>
            <div class="skeleton skeleton-text" style="width:90%"></div>
            <div class="skeleton skeleton-image mt-3"></div>
        </div>
    }
    else if (_style == null)
    {
        <div class="text-center py-5">
            <div class="empty-detail">
                <i class="bi bi-scissors" style="font-size: 2rem; color: var(--salon-light-gray);"></i>
                <p class="mt-2">스타일을 찾을 수 없습니다.</p>
                <a href="" class="btn btn-salon mt-2">홈으로 돌아가기</a>
            </div>
        </div>
    }
    else
    {
        <!-- 제목 영역 -->
        <div class="detail-header">
            <div class="detail-ornament">
                <span class="detail-line"></span>
                <span class="detail-diamond">&#9830;</span>
                <span class="detail-line"></span>
            </div>
            <h1 class="detail-title">@_style.Title</h1>
            <!-- 카테고리 & 시술 태그 -->
            <div class="detail-tags">
                <span class="detail-tag @(_style.Category.IsFemale() ? "tag-female" : "tag-male")">@_style.Category.ToFullName()</span>
                <span class="detail-tag tag-service">@_style.Service</span>
            </div>
        </div>

        <!-- 이미지 캐러셀 -->
        <div class="detail-carousel-wrap">
            <ImageCarousel ImageUrls="_style.ImageUrls" />
        </div>

        <!-- 상세 설명 -->
        @if (!string.IsNullOrEmpty(_style.Description))
        {
            <div class="detail-section detail-desc-section">
                <div class="detail-description">
                    @((MarkupString)_style.Description)
                </div>
            </div>
        }

        <!-- 스타일 포인트 -->
        @if (HasQuickInfo)
        {
            <div class="quick-info-card">
                <div class="quick-info-header">
                    <i class="bi bi-stars"></i>
                    <span>스타일 포인트</span>
                </div>
                <div class="quick-info-body">
                    @if (_style.RecommendedHairTypes.Any())
                    {
                        <div class="quick-info-row">
                            <span class="quick-info-label">추천 모질</span>
                            <span class="quick-info-value">@string.Join(" · ", _style.RecommendedHairTypes)</span>
                        </div>
                    }
                </div>
                @if (_style.RecommendedFor.Any())
                {
                    <div class="quick-info-recommend">
                        <div class="quick-info-recommend-label">
                            <i class="bi bi-person-check"></i>
                            <span>이런 분께 추천</span>
                        </div>
                        <div class="quick-info-recommend-tags">
                            @foreach (var rec in _style.RecommendedFor)
                            {
                                <span class="recommend-tag">@rec</span>
                            }
                        </div>
                    </div>
                }
                @if (!string.IsNullOrEmpty(_style.StylingTip))
                {
                    <div class="quick-info-tip">
                        <i class="bi bi-magic"></i>
                        <span>@_style.StylingTip</span>
                    </div>
                }
            </div>
        }

        <!-- 해시태그 -->
        @if (_style.Hashtags.Any())
        {
            <div class="detail-section">
                <HashtagList Hashtags="_style.Hashtags" />
            </div>
        }

        <!-- 연관 게시글 -->
        @if (_style.RelatedPostIds.Any())
        {
            <RelatedPosts RelatedPostIds="_style.RelatedPostIds" />
        }
    }
</div>

@code {
    [Parameter] public string Id { get; set; } = "";

    private StylePost? _style;
    private bool _loading = true;

    // 이전/다음 네비게이션
    private List<StylePost> _allStyles = new();
    private string? _prevId;
    private string? _nextId;
    private int _styleIndex = -1;
    private int _totalCount;

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;

        // 캐시에서 전체 목록 로드 (즉시 반환)
        _allStyles = await StyleService.GetAllAsync();
        _allStyles = _allStyles.Where(s => s.IsPublished).OrderByDescending(s => s.CreatedAt).ToList();
        _totalCount = _allStyles.Count;

        // 현재 스타일
        _style = _allStyles.FirstOrDefault(s => s.Id == Id);
        _styleIndex = _style != null ? _allStyles.IndexOf(_style) : -1;

        // 이전/다음 ID 설정
        _prevId = _styleIndex > 0 ? _allStyles[_styleIndex - 1].Id : null;
        _nextId = _styleIndex >= 0 && _styleIndex < _allStyles.Count - 1 ? _allStyles[_styleIndex + 1].Id : null;

        _loading = false;
    }

    private bool HasQuickInfo => _style != null && (
        _style.RecommendedHairTypes.Any() ||
        _style.RecommendedFor.Any() ||
        !string.IsNullOrEmpty(_style.StylingTip));

    private void GoBack() => Nav.NavigateTo("");
    private void GoPrev() { if (_prevId != null) Nav.NavigateTo($"style/{_prevId}"); }
    private void GoNext() { if (_nextId != null) Nav.NavigateTo($"style/{_nextId}"); }
}

<style>
    .salon-detail-page {
        max-width: 720px;
        padding: 0.5rem 1rem 2rem;
    }

    /* 네비게이션 바 */
    .detail-nav-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.3rem;
    }

    .btn-back {
        font-family: var(--font-serif);
        font-size: 0.8rem;
        color: var(--salon-gray);
        background: none;
        border: none;
        padding: 0.6rem 0;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
    }

    .btn-back:hover {
        color: var(--salon-black);
        transform: translateX(-3px);
    }

    .btn-back i {
        font-size: 0.7rem;
        transition: transform 0.3s;
    }

    .btn-back:hover i {
        transform: translateX(-2px);
    }

    .detail-nav-arrows {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .btn-nav-arrow {
        width: 32px;
        height: 32px;
        padding: 0;
        border: 1px solid var(--salon-light-gray);
        background: var(--salon-white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--salon-gray);
        font-size: 0.75rem;
        transition: all 0.2s;
    }

    .btn-nav-arrow:hover {
        border-color: var(--salon-green);
        color: var(--salon-green);
    }

    .detail-nav-counter {
        font-family: var(--font-serif);
        font-size: 0.7rem;
        color: var(--salon-gray);
        letter-spacing: 0.05em;
        min-width: 3rem;
        text-align: center;
    }

    /* 제목 영역 */
    .detail-header {
        text-align: center;
        margin-bottom: 1.2rem;
    }

    .detail-ornament {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .detail-line {
        width: 30px;
        height: 1px;
        background: linear-gradient(to right, transparent, var(--salon-accent));
        opacity: 0.4;
    }

    .detail-line:last-child {
        background: linear-gradient(to left, transparent, var(--salon-accent));
    }

    .detail-diamond {
        font-size: 0.5rem;
        color: var(--salon-accent);
        opacity: 0.4;
    }

    .detail-title {
        font-family: var(--font-serif);
        font-size: 1.5rem;
        font-weight: 900;
        color: var(--salon-black);
        text-align: center;
        margin: 0 0 0.6rem;
        line-height: 1.5;
        letter-spacing: -0.02em;
    }

    /* 카테고리 & 성별 태그 */
    .detail-tags {
        display: flex;
        justify-content: center;
        gap: 0.4rem;
    }

    .detail-tag {
        font-family: var(--font-serif);
        font-size: 0.7rem;
        padding: 4px 16px;
        border-radius: 14px;
        letter-spacing: 0.05em;
        font-weight: 600;
    }

    .tag-female {
        background: linear-gradient(135deg, var(--salon-rose) 0%, var(--salon-rose-light) 100%);
        color: #fff;
    }

    .tag-male {
        background: linear-gradient(135deg, #6b9bd2 0%, #a3c4e8 100%);
        color: #fff;
    }

    .tag-service {
        background: var(--salon-dark);
        color: #fff;
    }

    /* 섹션 구분 */
    .detail-section {
        padding: 0.5rem 0;
        border-top: 1px solid rgba(232, 227, 220, 0.5);
    }

    .detail-desc-section {
        padding-bottom: 0;
        margin-bottom: 0;
    }

    .detail-carousel-wrap {
        margin-top: 0.3rem;
    }

    /* 상세 설명 */
    .detail-description {
        font-family: var(--font-serif);
        font-size: 0.88rem;
        line-height: 1.95;
        color: var(--salon-dark);
        padding: 0.8rem 0.2rem 0.5rem;
        word-break: keep-all;
        min-height: 120px;
    }

    .detail-description p {
        margin-bottom: 0.6rem;
    }

    .detail-description h3 {
        font-size: 1rem;
        font-weight: 700;
        margin: 1rem 0 0.4rem;
    }

    .detail-description hr {
        border: none;
        border-top: 1px solid var(--salon-light-gray);
        margin: 1rem 0;
    }

    .empty-detail {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* 한눈에 보기 카드 */
    .quick-info-card {
        background: linear-gradient(135deg, #fdfcfb 0%, #f5f0eb 100%);
        border: 1.5px solid var(--salon-green);
        border-radius: 14px;
        margin: 1rem 0;
        overflow: hidden;
        box-shadow: 0 3px 12px rgba(123, 163, 131, 0.15);
    }

    .quick-info-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem 1rem;
        background: linear-gradient(135deg, rgba(123, 163, 131, 0.18) 0%, rgba(123, 163, 131, 0.08) 100%);
        border-bottom: 1px solid rgba(123, 163, 131, 0.2);
        font-family: var(--font-serif);
        font-size: 0.85rem;
        font-weight: 800;
        color: var(--salon-dark);
        letter-spacing: 0.02em;
    }

    .quick-info-header i {
        color: var(--salon-green);
        font-size: 1rem;
    }

    .quick-info-body {
        padding: 0.7rem 1rem;
    }

    .quick-info-row {
        display: flex;
        align-items: center;
        padding: 0.45rem 0;
        border-bottom: 1px solid rgba(232, 227, 220, 0.4);
    }

    .quick-info-row:last-child {
        border-bottom: none;
    }

    .quick-info-label {
        font-family: var(--font-serif);
        font-size: 0.78rem;
        color: var(--salon-gray);
        min-width: 80px;
        flex-shrink: 0;
        font-weight: 600;
    }

    .quick-info-value {
        font-family: var(--font-serif);
        font-size: 0.82rem;
        color: var(--salon-dark);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.15rem;
        flex-wrap: wrap;
    }

    .quick-dot {
        font-size: 0.7rem;
        color: #ddd;
    }

    .quick-dot.active {
        color: #e8a840;
    }

    .quick-info-tip {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.7rem 1rem;
        background: rgba(123, 163, 131, 0.08);
        border-top: 1px solid rgba(123, 163, 131, 0.2);
        font-family: var(--font-serif);
        font-size: 0.8rem;
        color: var(--salon-dark);
        line-height: 1.7;
    }

    .quick-info-tip i {
        color: var(--salon-green);
        font-size: 0.85rem;
        margin-top: 0.15rem;
        flex-shrink: 0;
    }

    /* 이런 분께 추천 */
    .quick-info-recommend {
        padding: 0.7rem 1rem;
        border-top: 1px solid rgba(232, 227, 220, 0.4);
    }

    .quick-info-recommend-label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-family: var(--font-serif);
        font-size: 0.78rem;
        font-weight: 700;
        color: var(--salon-dark);
        margin-bottom: 0.5rem;
    }

    .quick-info-recommend-label i {
        color: var(--salon-rose);
        font-size: 0.85rem;
    }

    .quick-info-recommend-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
    }

    .recommend-tag {
        font-family: var(--font-serif);
        font-size: 0.72rem;
        padding: 4px 12px;
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(212, 160, 160, 0.12) 0%, rgba(212, 160, 160, 0.06) 100%);
        border: 1px solid rgba(212, 160, 160, 0.25);
        color: var(--salon-dark);
        font-weight: 600;
        letter-spacing: -0.01em;
    }

    @@media (max-width: 576px) {
        .detail-title {
            font-size: 1.2rem;
        }

        .detail-description {
            font-size: 0.84rem;
            line-height: 1.85;
        }

        .quick-info-label {
            min-width: 70px;
            font-size: 0.72rem;
        }

        .quick-info-value {
            font-size: 0.75rem;
        }
    }

    /* 태블릿 반응형 */
    @@media (min-width: 768px) {
        .salon-detail-page {
            max-width: 800px;
        }

        .btn-back {
            font-size: 0.95rem;
            padding: 0.75rem 0;
        }

        .btn-back i {
            font-size: 0.85rem;
        }

        .btn-nav-arrow {
            width: 44px;
            height: 44px;
            font-size: 0.9rem;
        }

        .detail-nav-counter {
            font-size: 0.82rem;
        }

        .detail-title {
            font-size: 1.5rem;
        }

        .detail-description {
            font-size: 0.98rem;
        }

        .quick-info-header {
            font-size: 0.95rem;
            padding: 0.8rem 1.2rem;
        }

        .quick-info-header i {
            font-size: 1.1rem;
        }

        .quick-info-label {
            font-size: 0.88rem;
            min-width: 95px;
        }

        .quick-info-value {
            font-size: 0.92rem;
        }

        .quick-dot {
            font-size: 0.8rem;
        }

        .quick-info-tip {
            font-size: 0.9rem;
            padding: 0.8rem 1.2rem;
        }

        .quick-info-recommend {
            padding: 0.8rem 1.2rem;
        }

        .quick-info-recommend-label {
            font-size: 0.88rem;
        }

        .recommend-tag {
            font-size: 0.8rem;
            padding: 5px 14px;
        }
    }
</style>
