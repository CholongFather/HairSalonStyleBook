@inject IJSRuntime JS

<div id="@_carouselId" class="carousel slide salon-carousel" data-bs-ride="false" data-bs-touch="true" data-bs-interval="false">
    @if (ImageUrls.Count > 1)
    {
        <div class="carousel-indicators">
            @for (int i = 0; i < ImageUrls.Count; i++)
            {
                var index = i;
                <button type="button"
                        data-bs-target="#@_carouselId"
                        data-bs-slide-to="@index"
                        class="@(index == 0 ? "active" : "")"
                        aria-label="슬라이드 @(index + 1)"></button>
            }
        </div>
    }
    <div class="carousel-inner">
        @for (int i = 0; i < ImageUrls.Count; i++)
        {
            <div class="carousel-item @(i == 0 ? "active" : "")">
                <img src="@ImageUrls[i]" class="d-block w-100" alt="스타일 사진 @(i + 1)"
                     onload="this.classList.add('loaded')"
                     onerror="this.onerror=null;this.src='images/default-style.svg'" />
            </div>
        }
        @if (ImageUrls.Count == 0)
        {
            <div class="carousel-item active">
                <div class="carousel-placeholder">
                    <i class="bi bi-image"></i>
                    <p>사진이 없습니다</p>
                </div>
            </div>
        }
    </div>
    @if (ImageUrls.Count > 1)
    {
        <button class="carousel-control-prev" type="button" data-bs-target="#@_carouselId" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#@_carouselId" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
        </button>
        <div class="carousel-counter">
            <span class="carousel-counter-current">1</span> / @ImageUrls.Count
        </div>
    }
</div>

@code {
    [Parameter] public List<string> ImageUrls { get; set; } = new();

    private string _carouselId = $"carousel-{Guid.NewGuid():N}"[..16];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ImageUrls.Count > 1)
        {
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    var el = document.getElementById('{_carouselId}');
                    if (!el) return;
                    new bootstrap.Carousel(el, {{ touch: true, interval: false }});

                    // 슬라이드 카운터 업데이트
                    el.addEventListener('slid.bs.carousel', function(e) {{
                        var counter = el.querySelector('.carousel-counter-current');
                        if (counter) counter.textContent = e.to + 1;
                    }});

                    // 커스텀 터치 스와이프
                    var startX = 0, startY = 0, moving = false;
                    el.addEventListener('touchstart', function(e) {{
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                        moving = true;
                    }}, {{ passive: true }});
                    el.addEventListener('touchend', function(e) {{
                        if (!moving) return;
                        moving = false;
                        var diffX = e.changedTouches[0].clientX - startX;
                        var diffY = e.changedTouches[0].clientY - startY;
                        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 40) {{
                            var inst = bootstrap.Carousel.getInstance(el);
                            if (diffX < 0) inst.next();
                            else inst.prev();
                        }}
                    }}, {{ passive: true }});
                }})();
            ");
        }
    }
}

<style>
    .salon-carousel {
        max-width: 600px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(135deg, #f0ebe0 0%, #e8e3d8 50%, #f0ebe0 100%);
        background-size: 200% 100%;
        animation: carousel-shimmer 1.5s ease-in-out infinite;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    @@keyframes carousel-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .salon-carousel .carousel-item img {
        aspect-ratio: 3 / 4;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.4s ease;
    }

    .salon-carousel .carousel-item img.loaded {
        opacity: 1;
    }

    .salon-carousel .carousel-control-prev,
    .salon-carousel .carousel-control-next {
        width: 36px;
        height: 36px;
        top: 50%;
        transform: translateY(-50%);
        bottom: auto;
        opacity: 0.7;
    }

    .salon-carousel .carousel-control-prev {
        left: 8px;
    }

    .salon-carousel .carousel-control-next {
        right: 8px;
    }

    .salon-carousel .carousel-control-prev-icon,
    .salon-carousel .carousel-control-next-icon {
        background-color: rgba(0, 0, 0, 0.45);
        border-radius: 50%;
        padding: 0.9rem;
        background-size: 50%;
    }

    .salon-carousel .carousel-indicators {
        margin-bottom: 0.5rem;
    }

    .salon-carousel .carousel-indicators button {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.6);
        border: none;
        margin: 0 3px;
    }

    .salon-carousel .carousel-indicators button.active {
        background-color: #fff;
    }

    .carousel-counter {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.45);
        color: #fff;
        font-size: 0.7rem;
        padding: 2px 10px;
        border-radius: 10px;
        font-family: var(--font-serif);
        letter-spacing: 0.05em;
        z-index: 5;
    }

    .carousel-placeholder {
        aspect-ratio: 3 / 4;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--salon-gray);
        font-size: 1rem;
    }

    .carousel-placeholder i {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }
</style>
