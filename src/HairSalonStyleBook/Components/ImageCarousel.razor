@inject IJSRuntime JS

<div id="@_carouselId" class="carousel slide salon-carousel" data-bs-ride="false" data-bs-touch="true" data-bs-interval="false">
    @if (ImageUrls.Count > 1)
    {
        <div class="carousel-indicators">
            @for (int i = 0; i < ImageUrls.Count; i++)
            {
                var index = i;
                <button type="button"
                        data-bs-target="#@_carouselId"
                        data-bs-slide-to="@index"
                        class="@(index == 0 ? "active" : "")"
                        aria-label="슬라이드 @(index + 1)"></button>
            }
        </div>
    }
    <div class="carousel-inner">
        @for (int i = 0; i < ImageUrls.Count; i++)
        {
            <div class="carousel-item @(i == 0 ? "active" : "")">
                @{ var capturedIndex = i; }
                <img src="@ImageUrls[i]" class="d-block w-100" alt="스타일 사진 @(i + 1)"
                     onload="this.classList.add('loaded')"
                     onerror="this.onerror=null;this.src='images/default-style.svg'"
                     @onclick="() => OpenFullscreen(capturedIndex)" />
            </div>
        }
        @if (ImageUrls.Count == 0)
        {
            <div class="carousel-item active">
                <div class="carousel-placeholder">
                    <i class="bi bi-image"></i>
                    <p>사진이 없습니다</p>
                </div>
            </div>
        }
    </div>
    @if (ImageUrls.Count > 1)
    {
        <button class="carousel-control-prev" type="button" data-bs-target="#@_carouselId" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#@_carouselId" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
        </button>
        <div class="carousel-counter">
            <span class="carousel-counter-current">1</span> / @ImageUrls.Count
        </div>
    }
    <!-- 워터마크 -->
    @if (ImageUrls.Count > 0)
    {
        <div class="carousel-watermark">늘~오던 헤어살롱</div>
    }
</div>

@if (_showFullscreen)
{
    <div class="img-fullscreen-overlay" @onclick="CloseFullscreen">
        <button class="img-fs-close" @onclick="CloseFullscreen">
            <i class="bi bi-x-lg"></i>
        </button>
        <div class="img-fs-inner" @onclick:stopPropagation>
            <img src="@_fullscreenUrl" alt="풀스크린 이미지" />
            <div class="img-fs-watermark">늘~오던 헤어살롱</div>
        </div>
        @if (ImageUrls.Count > 1)
        {
            <div class="img-fs-counter">@(_fullscreenIndex + 1) / @ImageUrls.Count</div>
            <button class="img-fs-nav img-fs-prev" @onclick="FsPrev" @onclick:stopPropagation>
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="img-fs-nav img-fs-next" @onclick="FsNext" @onclick:stopPropagation>
                <i class="bi bi-chevron-right"></i>
            </button>
        }
    </div>
}

@code {
    [Parameter] public List<string> ImageUrls { get; set; } = new();

    private string _carouselId = $"carousel-{Guid.NewGuid():N}"[..16];

    // 풀스크린
    private bool _showFullscreen;
    private string _fullscreenUrl = "";
    private int _fullscreenIndex;

    private void OpenFullscreen(int index)
    {
        _fullscreenIndex = index;
        _fullscreenUrl = ImageUrls[index];
        _showFullscreen = true;
    }

    private void CloseFullscreen() => _showFullscreen = false;

    private void FsPrev()
    {
        _fullscreenIndex = (_fullscreenIndex - 1 + ImageUrls.Count) % ImageUrls.Count;
        _fullscreenUrl = ImageUrls[_fullscreenIndex];
    }

    private void FsNext()
    {
        _fullscreenIndex = (_fullscreenIndex + 1) % ImageUrls.Count;
        _fullscreenUrl = ImageUrls[_fullscreenIndex];
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ImageUrls.Count > 1)
        {
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    var el = document.getElementById('{_carouselId}');
                    if (!el) return;
                    new bootstrap.Carousel(el, {{ touch: true, interval: false }});

                    // 슬라이드 카운터 업데이트
                    el.addEventListener('slid.bs.carousel', function(e) {{
                        var counter = el.querySelector('.carousel-counter-current');
                        if (counter) counter.textContent = e.to + 1;
                    }});

                    // 커스텀 터치 스와이프
                    var startX = 0, startY = 0, moving = false;
                    el.addEventListener('touchstart', function(e) {{
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                        moving = true;
                    }}, {{ passive: true }});
                    el.addEventListener('touchend', function(e) {{
                        if (!moving) return;
                        moving = false;
                        var diffX = e.changedTouches[0].clientX - startX;
                        var diffY = e.changedTouches[0].clientY - startY;
                        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 40) {{
                            var inst = bootstrap.Carousel.getInstance(el);
                            if (diffX < 0) inst.next();
                            else inst.prev();
                        }}
                    }}, {{ passive: true }});
                }})();
            ");
        }
    }
}

<style>
    .salon-carousel {
        max-width: 600px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(135deg, #f0ebe0 0%, #e8e3d8 50%, #f0ebe0 100%);
        background-size: 200% 100%;
        animation: carousel-shimmer 1.5s ease-in-out infinite;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    @@keyframes carousel-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .salon-carousel .carousel-item img {
        aspect-ratio: 3 / 4;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.4s ease;
    }

    .salon-carousel .carousel-item img.loaded {
        opacity: 1;
    }

    .salon-carousel .carousel-control-prev,
    .salon-carousel .carousel-control-next {
        width: 44px;
        height: 44px;
        top: 50%;
        transform: translateY(-50%);
        bottom: auto;
        opacity: 0.8;
    }

    .salon-carousel .carousel-control-prev {
        left: 6px;
    }

    .salon-carousel .carousel-control-next {
        right: 6px;
    }

    .salon-carousel .carousel-control-prev-icon,
    .salon-carousel .carousel-control-next-icon {
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        padding: 1rem;
        background-size: 50%;
    }

    .salon-carousel .carousel-indicators {
        margin-bottom: 0.5rem;
    }

    .salon-carousel .carousel-indicators button {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.6);
        border: none;
        margin: 0 3px;
    }

    .salon-carousel .carousel-indicators button.active {
        background-color: #fff;
    }

    .carousel-counter {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.45);
        color: #fff;
        font-size: 0.7rem;
        padding: 2px 10px;
        border-radius: 10px;
        font-family: var(--font-serif);
        letter-spacing: 0.05em;
        z-index: 5;
    }

    .carousel-placeholder {
        aspect-ratio: 3 / 4;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--salon-gray);
        font-size: 1rem;
    }

    .carousel-placeholder i {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }

    .salon-carousel .carousel-item img {
        cursor: pointer;
    }

    /* 풀스크린 오버레이 */
    .img-fullscreen-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: imgFsIn 0.2s ease;
    }

    @@keyframes imgFsIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .img-fs-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }

    .img-fs-inner {
        max-width: 90vw;
        max-height: 85vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .img-fs-inner img {
        max-width: 100%;
        max-height: 85vh;
        object-fit: contain;
        border-radius: 8px;
    }

    .img-fs-counter {
        position: absolute;
        bottom: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        font-family: var(--font-serif);
        font-size: 0.8rem;
        padding: 4px 16px;
        border-radius: 16px;
        letter-spacing: 0.05em;
    }

    .img-fs-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 1.3rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .img-fs-nav:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .img-fs-prev { left: 1rem; }
    .img-fs-next { right: 1rem; }

    /* 워터마크 */
    .carousel-watermark {
        position: absolute;
        bottom: 12px;
        left: 12px;
        font-family: var(--font-serif);
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.3);
        letter-spacing: 0.08em;
        pointer-events: none;
        z-index: 5;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
        user-select: none;
    }

    .img-fs-watermark {
        position: absolute;
        bottom: 20px;
        left: 20px;
        font-family: var(--font-serif);
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.25);
        letter-spacing: 0.1em;
        pointer-events: none;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        user-select: none;
    }

    /* 태블릿 반응형 */
    @@media (min-width: 768px) {
        .salon-carousel .carousel-control-prev,
        .salon-carousel .carousel-control-next {
            width: 56px;
            height: 56px;
        }

        .salon-carousel .carousel-control-prev-icon,
        .salon-carousel .carousel-control-next-icon {
            padding: 1.2rem;
        }

        .carousel-counter {
            font-size: 0.85rem;
            padding: 3px 14px;
        }

        .img-fs-nav {
            width: 56px;
            height: 56px;
            font-size: 1.5rem;
        }

        .img-fs-counter {
            font-size: 0.95rem;
            padding: 5px 20px;
        }

        .img-fs-close {
            width: 52px;
            height: 52px;
            font-size: 1.4rem;
        }
    }
</style>
